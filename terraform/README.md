# Terraform Infrastructure for YSC S3 Resources

This directory contains Terraform configurations for managing S3 resources for different environments using a unified configuration.

## Structure

- `main.tf` - Unified Terraform configuration for all environments
- `variables.tf` - Variable definitions
- `sandbox/terraform.tfvars.example` - Example variables for sandbox
- `production/terraform.tfvars.example` - Example variables for production

## Prerequisites

1. Install Terraform (>= 1.0)
2. Configure AWS credentials:
   ```bash
   aws configure
   # OR set environment variables:
   export AWS_ACCESS_KEY_ID=your_key
   export AWS_SECRET_ACCESS_KEY=your_secret
   export AWS_DEFAULT_REGION=us-west-1
   ```

## Usage

The Terraform configuration uses an `environment` variable to construct the bucket name. The bucket name will be `{bucket_name_prefix}-{environment}` (e.g., `ysc-media-sandbox` or `ysc-media-production`).

### Sandbox Environment

1. Copy the example terraform.tfvars file:

   ```bash
   cd terraform
   cp sandbox/terraform.tfvars.example terraform.tfvars.sandbox
   ```

2. Review and update `terraform.tfvars.sandbox` if needed:

   - `environment`: "sandbox"
   - `bucket_name_prefix`: "ysc-media" (bucket will be `ysc-media-sandbox`)
   - `aws_region`: "us-west-1"
   - `allowed_cors_origins`: ["*"] (restrict in production)

3. Initialize Terraform:

   ```bash
   terraform init
   ```

4. Review the execution plan:

   ```bash
   terraform plan -var-file=terraform.tfvars.sandbox
   ```

5. Apply the configuration:

   ```bash
   terraform apply -var-file=terraform.tfvars.sandbox
   ```

6. After applying, note the outputs:

   - `bucket_name`: The S3 bucket name (e.g., `ysc-media-sandbox`)
   - `access_key_id`: IAM access key ID for the application
   - `secret_access_key`: IAM secret access key (sensitive)
   - `s3_base_url`: Base URL for the S3 bucket

7. Set environment variables in your deployment:
   ```bash
   export S3_BUCKET=<bucket_name from output>
   export S3_REGION=us-west-1
   export S3_BASE_URL=<s3_base_url from output>
   export AWS_ACCESS_KEY_ID=<access_key_id from output>
   export AWS_SECRET_ACCESS_KEY=<secret_access_key from output>
   ```

### Production Environment

1. Copy the example terraform.tfvars file:

   ```bash
   cd terraform
   cp production/terraform.tfvars.example terraform.tfvars.production
   ```

2. **IMPORTANT**: Update `terraform.tfvars.production`:

   - `environment`: "production"
   - `bucket_name_prefix`: "ysc-media" (bucket will be `ysc-media-production`)
   - `allowed_cors_origins`: **Restrict to your actual production domains** (e.g., `["https://ysc.example.com"]`)

3. Initialize Terraform (if not already done):

   ```bash
   terraform init
   ```

4. Review the execution plan:

   ```bash
   terraform plan -var-file=terraform.tfvars.production
   ```

5. Apply the configuration:

   ```bash
   terraform apply -var-file=terraform.tfvars.production
   ```

6. Store outputs securely (e.g., in a secrets manager):
   - `bucket_name`
   - `access_key_id`
   - `secret_access_key` (sensitive)
   - `s3_base_url`

## What Gets Created

For all environments, Terraform creates:

1. **S3 Bucket**:

   - Bucket name: `{bucket_name_prefix}-{environment}` (e.g., `ysc-media-sandbox`)
   - Versioning enabled
   - Server-side encryption (AES256)
   - CORS configuration for browser uploads (required for pre-signed POST uploads)
   - Public read access for `public/*` objects
   - Public write access for `public/*` objects (for pre-signed POST uploads with `public-read` ACL)
   - Lifecycle rules (production only)

2. **IAM User and Policy**:
   - IAM user: `{bucket_name}-app-user`
   - IAM access keys
   - IAM policy with permissions for:
     - `s3:PutObject` (required for pre-signed uploads)
     - `s3:GetObject`
     - `s3:DeleteObject`
     - `s3:PutObjectAcl` (required for pre-signed uploads with ACL)
     - `s3:ListBucket`

## Pre-signed URL Support

The Terraform configuration is designed to fully support pre-signed POST uploads:

- **CORS**: Configured to allow POST, PUT, GET, HEAD from allowed origins
- **Bucket Policy**: Allows public write access to `public/*` objects. The pre-signed POST policy (generated by SimpleS3Upload) enforces the ACL (`public-read`) and other conditions.
- **IAM Policy**: Grants `s3:PutObject` and `s3:PutObjectAcl` permissions needed to generate pre-signed URLs

## State Management

For production use, configure a remote state backend in `main.tf`:

```hcl
backend "s3" {
  bucket = "your-terraform-state-bucket"
  key    = "${var.environment}/s3.tfstate"
  region = var.aws_region
  encrypt = true
}
```

This will create separate state files for each environment (e.g., `sandbox/s3.tfstate`, `production/s3.tfstate`).

## Security Considerations

1. **Access Keys**: Store IAM access keys securely (AWS Secrets Manager, etc.)
2. **CORS Origins**: Restrict `allowed_cors_origins` to your actual domains in production
3. **Bucket Policy**: Review the bucket policy to ensure it matches your security requirements
4. **Public Access**: The bucket allows public read access for `public/*` objects. Adjust as needed.

## Destroying Resources

To destroy the infrastructure for a specific environment:

```bash
# For sandbox
terraform destroy -var-file=terraform.tfvars.sandbox

# For production
terraform destroy -var-file=terraform.tfvars.production
```

**WARNING**: This will delete the S3 bucket and all objects in it. Make sure you have backups if needed.

## Quick Start Examples

### Deploy Sandbox Environment

```bash
cd terraform
cp sandbox/terraform.tfvars.example terraform.tfvars.sandbox
terraform init
terraform plan -var-file=terraform.tfvars.sandbox
terraform apply -var-file=terraform.tfvars.sandbox
```

### Deploy Production Environment

```bash
cd terraform
cp production/terraform.tfvars.example terraform.tfvars.production
# Edit terraform.tfvars.production to set your production CORS origins
terraform plan -var-file=terraform.tfvars.production
terraform apply -var-file=terraform.tfvars.production
```

### Using Command-Line Variables

Alternatively, you can pass variables directly without tfvars files:

```bash
# Sandbox
terraform apply \
  -var="environment=sandbox" \
  -var="bucket_name_prefix=ysc-media" \
  -var="aws_region=us-west-1"

# Production
terraform apply \
  -var="environment=production" \
  -var="bucket_name_prefix=ysc-media" \
  -var="aws_region=us-west-1" \
  -var='allowed_cors_origins=["https://ysc.example.com"]'
```

## Environment Variables Reference

After applying Terraform, set these environment variables in your application:

- `S3_BUCKET`: The S3 bucket name (from Terraform output)
- `S3_REGION`: AWS region (e.g., `us-west-1`)
- `S3_BASE_URL`: Base URL for the S3 bucket (from Terraform output, optional)
- `AWS_ACCESS_KEY_ID`: IAM access key ID (from Terraform output)
- `AWS_SECRET_ACCESS_KEY`: IAM secret access key (from Terraform output)

If `S3_BASE_URL` is not set, the application will construct the URL from bucket name and region.
